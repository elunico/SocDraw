<html lang="en">

<head>
  <title></title>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    if (window.location.hostname == 'localhost') {
      console.log('[+] localhost socket')
      var socket = io('http://192.168.56.1:8000/');
    }
    else {
      console.log('[+] heroku socket')
      var socket = io('https://socdraw.herokuapp.com/');
    };
    var id;
    socket.on('connected', function (data) {
      console.log("Connected! id=" + data.id);
      id = data.id;
    });
    socket.on('previous data', function (data) {
      for (let d of data.previousData) {
        if (d.type == 'flood fill') {
          loadPixels();
          floodFill(d.x, d.y, d.color, d.base);
          updatePixels();
        } else if (d.type == 'paint') {
          drawIncomingData(d);
        }
      }
    })
    socket.on('nack', function (data) {
      console.log('Error server got bad data');
    });
    socket.on('incoming drawing', function (data) {
      if (data.source != id) {
        drawIncomingData(data);
      }
    });
    socket.on('room removed', function (data) {
      window.location = '/error.html';
    });
    socket.on('clear canvas', function (data) {
      console.log('received clear');
      clearCanvas();
    });
    socket.on('flood fill', function (data) {
      loadPixels();
      floodFill(data.x, data.y, data.color, data.base);
      updatePixels();
    })
    socket.on('mouse released', function (data) { last = { x: undefined, y: undefined }; });

    let components = window.location.pathname.split('/');
    let room = components[components.length - 1];

    let title = document.querySelector('title');
    title.textContent = `SocDraw in room ${room}`;

    socket.emit('needs assignment', { room });
  </script>
  <script src="/libraries/p5.js"></script>
  <script src="/libraries/p5.dom.js"></script>
  <script src="/path.js"></script>
  <script src="/sketch.js"></script>
  <script src="/history.js"></script>

  <style>
    body>* {
      margin: 4px;
    }

    h1 {
      font-size: 1.5em;
    }
  </style>

</head>

<body>
  <h1 id="room-name"></h1>
  <img alt="Shows the current state of the canvas. Hidden until user clicks 'save canvas'" width="800" height="600"
    id="save-img" hidden src="">
  <script>
    (function () {
      window.addEventListener("touchstart", function (e) {
        if (e.target == canvas.elt)
          e.preventDefault();
      }, { passive: false });
      window.addEventListener("touchend", function (e) {
        if (e.target == canvas.elt)
          e.preventDefault();
      }, { passive: false });
      window.addEventListener("touchmove", function (e) {
        if (e.target == canvas.elt)
          e.preventDefault();
      }, { passive: false });
    })();

    let roomName = document.querySelector('#room-name');
    roomName.textContent = 'Your room is: ' + window.location.pathname.split('/').pop();
  </script>
</body>

</html>
